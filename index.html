<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>ババ抜き大会管理</title>
 <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
 <link rel="stylesheet" href="style.css" />
 <script type="module" src="app.js"></script>
<script>
const $view   = document.getElementById('view');
const $btnL   = document.getElementById('btnLoad');
const $btnS   = document.getElementById('btnSave');

let db = { rev: 0, data: { msg: 'Hello' }, sig: '' };

/* ========== 共通ユーティリティ ========== */
function show(msg, ok = true) {
  $status.textContent = msg;
  $status.style.color = ok ? 'green' : 'red';
}

function render() {
  $view.textContent = JSON.stringify(db, null, 2);
}

/* ========== 処理 ========== */
async function refresh() {
  try {
    db = await load();
    render();
    show('✅ 読み取り成功 rev=' + db.rev);
  } catch (err) {
    show('❌ 読み取り失敗: ' + err, false);
  }
}

async function store() {
  try {
    db.data.msg = prompt('新メッセージを入力', db.data.msg);
    if (db.data.msg === null) return;          // キャンセル
    db.sig = await makeSig(db.data);
    db     = await save(db.data, db.rev, db.sig);
    render();
    show('✅ 保存成功 rev=' + db.rev);
  } catch (err) {
    show('❌ 保存失敗: ' + err, false);
  }
}

/* ========== イベント ========== */
$btnL.onclick = refresh;
$btnS.onclick = store;
refresh();
</script>
</head>
<body>
  <div id="app">
    <!-- サイドバー -->
    <nav id="sidebar">
      <h2>メニュー</h2>
      <ul>
        <li onclick="navigate('scan')">📷 QRコードスキャン</li>
        <li onclick="navigate('ranking')">🥇 順位登録</li>
        <li onclick="navigateToExternal('https://qr212345.github.io/fajjfiur/')">📊 レート表</li>
        <li onclick="navigateToExternal('https://qr212345.github.io/asdfghjkl/')">🪑 座席情報</li>
      </ul>
    </nav>

    <!-- メイン表示エリア -->
    <main id="mainContent">
      <!-- スキャンUI -->
      <section id="scanSection" class="section">
        <h2>QRコードスキャン</h2>
        <div id="reader" style="width: 320px"></div>
        <div id="messageArea"></div>
        <div id="seatList"></div>
        <button onclick="undoAction()">↩ Undo</button>
        <button onclick="saveToCSV()">📄 CSVで保存</button>
        <button id="btnSave">☁ Driveに保存</button>
        <button id="btnLoad">☁ Driveから読み込み</button>
        </section>

      <!-- 順位登録UI -->
      <section id="rankingSection" class="section" style="display:none">
        <h2>順位登録モード</h2>
        <p>QRコードで座席を読み込んでください。</p>
        <div id="rankingReader" style="width: 320px;"></div>
        <ul id="rankingList" class="draggable-list"></ul>
        <button onclick="confirmRanking()">✅ 順位決定</button>
      </section>
    </main>
  </div>
</body>
</html>
