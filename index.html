<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>ãƒãƒæŠœãå¤§ä¼šç®¡ç†</title>
 <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
 <link rel="stylesheet" href="style.css" />
 <script type="module" src="app.js"></script>
<script>
const $view   = document.getElementById('view');
const $btnL   = document.getElementById('btnLoad');
const $btnS   = document.getElementById('btnSave');

let db = { rev: 0, data: { msg: 'Hello' }, sig: '' };

/* ========== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
function show(msg, ok = true) {
  $status.textContent = msg;
  $status.style.color = ok ? 'green' : 'red';
}

function render() {
  $view.textContent = JSON.stringify(db, null, 2);
}

/* ========== å‡¦ç† ========== */
async function refresh() {
  try {
    db = await load();
    render();
    show('âœ… èª­ã¿å–ã‚ŠæˆåŠŸ rev=' + db.rev);
  } catch (err) {
    show('âŒ èª­ã¿å–ã‚Šå¤±æ•—: ' + err, false);
  }
}

async function store() {
  try {
    db.data.msg = prompt('æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›', db.data.msg);
    if (db.data.msg === null) return;          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    db.sig = await makeSig(db.data);
    db     = await save(db.data, db.rev, db.sig);
    render();
    show('âœ… ä¿å­˜æˆåŠŸ rev=' + db.rev);
  } catch (err) {
    show('âŒ ä¿å­˜å¤±æ•—: ' + err, false);
  }
}

/* ========== ã‚¤ãƒ™ãƒ³ãƒˆ ========== */
$btnL.onclick = refresh;
$btnS.onclick = store;
refresh();
</script>
</head>
<body>
  <div id="app">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <nav id="sidebar">
      <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <ul>
        <li onclick="navigate('scan')">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</li>
        <li onclick="navigate('ranking')">ğŸ¥‡ é †ä½ç™»éŒ²</li>
        <li onclick="navigateToExternal('https://qr212345.github.io/fajjfiur/')">ğŸ“Š ãƒ¬ãƒ¼ãƒˆè¡¨</li>
        <li onclick="navigateToExternal('https://qr212345.github.io/asdfghjkl/')">ğŸª‘ åº§å¸­æƒ…å ±</li>
      </ul>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <main id="mainContent">
      <!-- ã‚¹ã‚­ãƒ£ãƒ³UI -->
      <section id="scanSection" class="section">
        <h2>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
        <div id="reader" style="width: 320px"></div>
        <div id="messageArea"></div>
        <div id="seatList"></div>
        <button onclick="undoAction()">â†© Undo</button>
        <button onclick="saveToCSV()">ğŸ“„ CSVã§ä¿å­˜</button>
        <button id="btnSave">â˜ Driveã«ä¿å­˜</button>
        <button id="btnLoad">â˜ Driveã‹ã‚‰èª­ã¿è¾¼ã¿</button>
        </section>

      <!-- é †ä½ç™»éŒ²UI -->
      <section id="rankingSection" class="section" style="display:none">
        <h2>é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰</h2>
        <p>QRã‚³ãƒ¼ãƒ‰ã§åº§å¸­ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</p>
        <div id="rankingReader" style="width: 320px;"></div>
        <ul id="rankingList" class="draggable-list"></ul>
        <button onclick="confirmRanking()">âœ… é †ä½æ±ºå®š</button>
      </section>
    </main>
  </div>
</body>
</html>
